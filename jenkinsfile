pipeline {
  agent any
  stages {
   
    stage('Fetch dependencies') {
      
      steps {
      sh 'npm install'
    
      }
    }
    stage('Build') {
      steps {
       
        sh 'ng build'
      }
    }
    
     stage('code review') {
         steps {
             script {
              def scannerHome = tool 'sonar-scanner';
             
                   withSonarQubeEnv('sonar') {
                       sh "${scannerHome}/bin/sonar-scanner"
                }
             }
          }
      }
    stage('Kill old process'){
            steps {
                script {
                    sh ''' 
                 #!/bin/bash
                 lsof -t -i :4401| xargs --no-run-if-empty kill -9
                 '''
                }
            }
        }
     stage('deploy ') {
      
      steps {
         script {
           withEnv(['JENKINS_NODE_COOKIE=dontkillme']) {
                    sh ''' 
                 #!/bin/bash
             
                 nohup  ng serve --host 0.0.0.0 --port 4401 &

                 '''
           }
            sh "sleep 20"
                }
                
       
      
      }
    }
   
  }
   post {
    failure {
       mail to: 'issaouiadam42@gmail.com',
             subject: "Failed Pipeline: ${currentBuild.fullDisplayName}",
             body: "Something is wrong with ${env.BUILD_URL}"
    }
   
    success {
       mail to: 'issaouiadam42@gmail.com',
             subject: "success Pipeline: ${currentBuild.fullDisplayName}",
             body: "Everything is OK with ${env.BUILD_URL}"
    }
  }
}
